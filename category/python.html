<!DOCTYPE html>
<html lang="en">
<head>
        <meta charset="utf-8" />
        <title>Victor Stinner blog 3 - python</title>
        <link rel="stylesheet" href="https://vstinner.github.io/theme/css/main.css" />
        <link href="https://vstinner.github.io/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="Victor Stinner blog 3 Atom Feed" />

        <!--[if IE]>
            <script src="https://html5shiv.googlecode.com/svn/trunk/html5.js"></script>
        <![endif]-->
</head>

<body id="index" class="home">
        <header id="banner" class="body">
                <h1><a href="https://vstinner.github.io/">Victor Stinner blog 3 </a></h1>
                <nav><ul>
                    <li><a href="https://vstinner.github.io/category/benchmark.html">benchmark</a></li>
                    <li class="active"><a href="https://vstinner.github.io/category/python.html">python</a></li>
                </ul></nav>
        </header><!-- /#banner -->

            <aside id="featured" class="body">
                <article>
                    <h1 class="entry-title"><a href="https://vstinner.github.io/painful-history-python-filesystem-encoding.html">PEP 383: Non-decodable Bytes in System Character Interfaces</a></h1>
<footer class="post-info">
        <abbr class="published" title="2018-03-15T18:00:00+01:00">
                Published: jeu. 15 mars 2018
        </abbr>

        <address class="vcard author">
                By                         <a class="url fn" href="https://vstinner.github.io/author/victor-stinner.html">Victor Stinner</a>
        </address>
<p>In <a href="https://vstinner.github.io/category/python.html">python</a>.</p>
<p>tags: <a href="https://vstinner.github.io/tag/cpython.html">cpython</a> </p>
</footer><!-- /.post-info --><p>In my previous article, I wrote that <tt class="docutils literal">os.listdir(str)</tt> ignored silently
undecodable filenames in Python 3.0 and that lying on the real content of a
directory looks like a very bad idea.</p>
<p><strong>Martin v. Löwis</strong> found a very smart solution to this problem: the
<tt class="docutils literal">surrogateescape</tt> error handler.</p>
<p><strong>This article is the second in a series of articles telling the history and
rationale of the Python 3 Unicode model for the operating system:</strong></p>
<ul class="simple">
<li><ol class="first arabic">
<li><a class="reference external" href="https://vstinner.github.io/python30-listdir-undecodable-filenames.html">Python 3.0 listdir() bug on undecodable filenames</a></li>
</ol>
</li>
<li><ol class="first arabic" start="2">
<li><a class="reference external" href="https://vstinner.github.io/painful-history-python-filesystem-encoding.html">PEP 383: Non-decodable Bytes in System Character Interfaces</a></li>
</ol>
</li>
</ul>
<div class="section" id="first-attempt-to-propose-the-solution">
<h2>First attempt to propose the solution</h2>
<p>September 2008, <a class="reference external" href="https://bugs.python.org/issue3187">bpo-3187</a>: While
solutions to fix <tt class="docutils literal">os.listdir(str)</tt> were discussed, <strong>Martin v. Löwis</strong>
<a class="reference external" href="https://bugs.python.org/issue3187#msg73992">proposed a different approach</a>:</p>
<blockquote>
<p>I'd like to propose yet another approach: make sure that <strong>conversion</strong>
according to the file system encoding <strong>always succeeds</strong>. <strong>If an
unconvertable byte is detected, map it into some private-use character.</strong>
To reduce the chance of conflict with other people's private-use
characters, we can use some of the plane 15 private-use characters, e.g.
map byte 0xPQ to U+F30PQ (in two-byte Unicode mode, this would result in
a surrogate pair).</p>
<p>This would make all file names accessible to all text processing
(including glob and friends); UI display would typically either report
an encoding error, or arrange for some replacement glyph to be shown.</p>
<p>There are certain variations of the approach possible, in case there is
objection to a specific detail.</p>
</blockquote>
<p>He amended this proposal:</p>
<blockquote>
<p><strong>James Knight</strong> points out that UTF-8b can be used to give unambiguous
round-tripping of characters in a UTF-8 locale. So I would like to amend my
previous proposal:</p>
<ul class="simple">
<li>for a non-UTF-8 encoding, use private-use characters for roundtripping</li>
<li>if the locale's charset is UTF-8, use UTF-8b as the file system encoding.</li>
</ul>
</blockquote>
<p><strong>But Martin's smart idea was lost</strong> in the middle of long discussion.</p>
<a class="reference external image-reference" href="https://github.com/loewis"><img alt="Martin v. Löwis" src="https://vstinner.github.io/images/martin_von_loewis.jpg" /></a>
</div>
<div class="section" id="pep-383">
<h2>PEP 383</h2>
<p>April 2009, Martin v. Löwis proposed again his idea, now as the well defined
<a class="reference external" href="http://www.python.org/dev/peps/pep-0383">PEP 383</a>: <strong>Non-decodable Bytes in System Character Interfaces</strong>. He <a class="reference external" href="https://mail.python.org/pipermail/python-dev/2009-April/088919.html">posted
his PEP to python-dev</a> for
comments.</p>
<p>Abstract:</p>
<blockquote>
<p>File names, environment variables, and command line arguments are defined
as being character data in POSIX; the C APIs however allow passing
arbitrary bytes - whether these conform to a certain encoding or not.</p>
<p><strong>This PEP proposes a means of dealing with such irregularities by embedding
the bytes in character strings in such a way that allows recreation of the
original byte string.</strong></p>
</blockquote>
<p>The <tt class="docutils literal">surrogateescape</tt> encoding is based on <strong>Markus Kuhn</strong>'s idea that he
called <strong>UTF-8b</strong>. Undecodable bytes in range <tt class="docutils literal"><span class="pre">0x80-0xff</span></tt> are mapped as
Unicode surrogate characters: range <tt class="docutils literal">U+DC80</tt> - <tt class="docutils literal">U+DCFF</tt>.</p>
<p>Example:</p>
<pre class="literal-block">
&gt;&gt;&gt; b'nonascii\xff'.decode('ascii')
UnicodeDecodeError: 'ascii' codec can't decode byte 0xff (...)
&gt;&gt;&gt; b'nonascii\xff'.decode('ascii', 'surrogateescape')
'nonascii\udcff'
&gt;&gt;&gt; 'nonascii\udcff'.encode('ascii', 'surrogateescape')
b'nonascii\xff'
</pre>
<p><a class="reference external" href="https://mail.python.org/pipermail/python-dev/2009-April/089278.html">The PEP was accepted</a> by
<strong>Guido van Rossum</strong> in less than one week!</p>
</div>
<div class="section" id="implementation">
<h2>Implementation</h2>
<p>May 2009, Martin v. Löwis opened the <a class="reference external" href="https://bugs.python.org/issue5915">bpo-5915</a> to get a review on his implementation.</p>
<p>Two days later, after <strong>Benjamin Peterson</strong> and <strong>Antoine Pitrou</strong> reviews,
Martin pushed the <a class="reference external" href="https://github.com/python/cpython/commit/011e8420339245f9b55d41082ec6036f2f83a182">commit 011e8420</a>:</p>
<blockquote>
Issue #5915: Implement PEP 383, Non-decodable Bytes
in System Character Interfaces.</blockquote>
<p>Five days later, Martin renamed his &quot;utf8b&quot; error handler to its final name
<strong>surrogateescape</strong>, <a class="reference external" href="https://github.com/python/cpython/commit/43c57785d3319249c03c3fa46c9df42a8ccd3e52">commit 43c57785</a>:</p>
<blockquote>
Rename utf8b error handler to surrogateescape.</blockquote>
<p><strong>Python 3.1</strong> will be the first release getting the <tt class="docutils literal">surrogateescape</tt> error
handler.</p>
</div>
<div class="section" id="conclusion">
<h2>Conclusion</h2>
<p>In Python 3.0, <tt class="docutils literal">os.listdir(str)</tt> ignored silently undecodable filenames which
was not ideal.</p>
<p><strong>Martin v. Löwis</strong> proposed to apply <strong>Markus Kuhn</strong>'s idea called <strong>UTF-8b</strong>
in Python as a new <tt class="docutils literal">surrogateescape</tt> error handler.</p>
<p>Martin's PEP was approved in less than one week and implemented a few days
later.</p>
<p>The <tt class="docutils literal">surrogateescape</tt> error handler fixed a lot of old and very complex
Unicode issues on Unix. It is still widely used in Python 3.6 to <strong>not annoy
users with Unicode errors</strong>.</p>
</div>
                </article>
            </aside><!-- /#featured -->
                <section id="content" class="body">
                    <h1>Other articles</h1>
                    <hr />
                    <ol id="posts-list" class="hfeed">

            <li><article class="hentry">
                <header>
                    <h1><a href="https://vstinner.github.io/python30-listdir-undecodable-filenames.html" rel="bookmark"
                           title="Permalink to Python 3.0 listdir() bug on undecodable filenames">Python 3.0 listdir() bug on undecodable filenames</a></h1>
                </header>

                <div class="entry-content">
<footer class="post-info">
        <abbr class="published" title="2018-03-09T13:00:00+01:00">
                Published: ven. 09 mars 2018
        </abbr>

        <address class="vcard author">
                By                         <a class="url fn" href="https://vstinner.github.io/author/victor-stinner.html">Victor Stinner</a>
        </address>
<p>In <a href="https://vstinner.github.io/category/python.html">python</a>.</p>
<p>tags: <a href="https://vstinner.github.io/tag/cpython.html">cpython</a> </p>
</footer><!-- /.post-info -->                <p>Ten years ago, when Python 3.0 final was released, <tt class="docutils literal">os.listdir(str)</tt>
<strong>ignored silently undecodable filenames</strong>:</p>
<pre class="literal-block">
$ python3.0
&gt;&gt;&gt; os.mkdir(b'x')
&gt;&gt;&gt; open(b'x/nonascii\xff', 'w').close()
&gt;&gt;&gt; os.listdir('x')
[]
</pre>
<p>You had to use bytes to see all filenames:</p>
<pre class="literal-block">
&gt;&gt;&gt; os.listdir(b'x')
[b'nonascii\xff']
</pre>
<p>If the locale is POSIX …</p>
                <a class="readmore" href="https://vstinner.github.io/python30-listdir-undecodable-filenames.html">read more</a>
                </div><!-- /.entry-content -->
            </article></li>

            <li><article class="hentry">
                <header>
                    <h1><a href="https://vstinner.github.io/python37-gil-change.html" rel="bookmark"
                           title="Permalink to How I fixed a very old GIL race condition in Python 3.7">How I fixed a very old GIL race condition in Python 3.7</a></h1>
                </header>

                <div class="entry-content">
<footer class="post-info">
        <abbr class="published" title="2018-03-08T10:00:00+01:00">
                Published: jeu. 08 mars 2018
        </abbr>

        <address class="vcard author">
                By                         <a class="url fn" href="https://vstinner.github.io/author/victor-stinner.html">Victor Stinner</a>
        </address>
<p>In <a href="https://vstinner.github.io/category/python.html">python</a>.</p>
<p>tags: <a href="https://vstinner.github.io/tag/cpython.html">cpython</a> </p>
</footer><!-- /.post-info -->                <p><strong>It took me 4 years to fix a nasty bug in the famous Python GIL</strong> (Global
Interpreter Lock), one of the most critical part of Python. I had to dig the
Git history to find a <strong>change made 26 years ago</strong> by <strong>Guido van Rossum</strong>: at
this time, <em>threads were …</em></p>
                <a class="readmore" href="https://vstinner.github.io/python37-gil-change.html">read more</a>
                </div><!-- /.entry-content -->
            </article></li>

            <li><article class="hentry">
                <header>
                    <h1><a href="https://vstinner.github.io/python37-pep-564-nanoseconds.html" rel="bookmark"
                           title="Permalink to Python 3.7 nanoseconds">Python 3.7 nanoseconds</a></h1>
                </header>

                <div class="entry-content">
<footer class="post-info">
        <abbr class="published" title="2018-03-06T16:30:00+01:00">
                Published: mar. 06 mars 2018
        </abbr>

        <address class="vcard author">
                By                         <a class="url fn" href="https://vstinner.github.io/author/victor-stinner.html">Victor Stinner</a>
        </address>
<p>In <a href="https://vstinner.github.io/category/python.html">python</a>.</p>
<p>tags: <a href="https://vstinner.github.io/tag/cpython.html">cpython</a> </p>
</footer><!-- /.post-info -->                <p>Thanks to my <a class="reference external" href="https://vstinner.github.io/python37-perf-counter-nanoseconds.html">latest change on time.perf_counter()</a>, all Python 3.7 clocks now use
nanoseconds as integer internally. It became possible to propose again my old
idea of getting time as nanoseconds at Python level and so I wrote a new
<a class="reference external" href="http://www.python.org/dev/peps/pep-0564">PEP 564</a> &quot;Add new time functions with nanosecond …</p>
                <a class="readmore" href="https://vstinner.github.io/python37-pep-564-nanoseconds.html">read more</a>
                </div><!-- /.entry-content -->
            </article></li>

            <li><article class="hentry">
                <header>
                    <h1><a href="https://vstinner.github.io/python37-perf-counter-nanoseconds.html" rel="bookmark"
                           title="Permalink to Python 3.7 perf_counter() nanoseconds">Python 3.7 perf_counter() nanoseconds</a></h1>
                </header>

                <div class="entry-content">
<footer class="post-info">
        <abbr class="published" title="2018-03-06T15:00:00+01:00">
                Published: mar. 06 mars 2018
        </abbr>

        <address class="vcard author">
                By                         <a class="url fn" href="https://vstinner.github.io/author/victor-stinner.html">Victor Stinner</a>
        </address>
<p>In <a href="https://vstinner.github.io/category/python.html">python</a>.</p>
<p>tags: <a href="https://vstinner.github.io/tag/cpython.html">cpython</a> </p>
</footer><!-- /.post-info -->                <p>Since 2012, I have been trying to convert all Python clocks to use internally
nanoseconds. The last clock which still used floating point internally was
<tt class="docutils literal">time.perf_counter()</tt>. INADA Naoki's new importtime tool was an opportunity
for me to have a new look on a tricky integer overflow issue.</p>
<div class="section" id="modify-importtime-to-use-time-perf-counter-clock">
<h2>Modify importtime …</h2></div>
                <a class="readmore" href="https://vstinner.github.io/python37-perf-counter-nanoseconds.html">read more</a>
                </div><!-- /.entry-content -->
            </article></li>

            <li><article class="hentry">
                <header>
                    <h1><a href="https://vstinner.github.io/contrib-cpython-2017q3-part3.html" rel="bookmark"
                           title="Permalink to My contributions to CPython during 2017 Q3: Part 3 (funny bugs)">My contributions to CPython during 2017 Q3: Part 3 (funny bugs)</a></h1>
                </header>

                <div class="entry-content">
<footer class="post-info">
        <abbr class="published" title="2017-10-19T16:00:00+02:00">
                Published: jeu. 19 octobre 2017
        </abbr>

        <address class="vcard author">
                By                         <a class="url fn" href="https://vstinner.github.io/author/victor-stinner.html">Victor Stinner</a>
        </address>
<p>In <a href="https://vstinner.github.io/category/python.html">python</a>.</p>
<p>tags: <a href="https://vstinner.github.io/tag/cpython.html">cpython</a> </p>
</footer><!-- /.post-info -->                <p>My contributions to <a class="reference external" href="https://www.python.org/">CPython</a> during 2017 Q3
(july, august, september), Part 3 (funny bugs).</p>
<p>Previous report: <a class="reference external" href="https://vstinner.github.io/contrib-cpython-2017q3-part2.html">My contributions to CPython during 2017 Q3: Part 2 (dangling
threads)</a>.</p>
<p>Summary:</p>
<ul class="simple">
<li>FreeBSD bug: minor() device regression</li>
<li>regrtest snowball effect when hunting memory leaks</li>
<li>Bugfixes</li>
<li>Other Changes</li>
</ul>
<div class="section" id="freebsd-bug-minor-device-regression">
<h2>FreeBSD bug: minor() device regression</h2>
<a class="reference external image-reference" href="https://www.freebsd.org/"><img alt="Logo of the FreeBSD project" src="https://vstinner.github.io/images/freebsd.png" /></a>
<p><a class="reference external" href="https://bugs.python.org/issue31044">bpo-31044</a>: The …</p></div>
                <a class="readmore" href="https://vstinner.github.io/contrib-cpython-2017q3-part3.html">read more</a>
                </div><!-- /.entry-content -->
            </article></li>

            <li><article class="hentry">
                <header>
                    <h1><a href="https://vstinner.github.io/contrib-cpython-2017q3-part2.html" rel="bookmark"
                           title="Permalink to My contributions to CPython during 2017 Q3: Part 2 (dangling threads)">My contributions to CPython during 2017 Q3: Part 2 (dangling threads)</a></h1>
                </header>

                <div class="entry-content">
<footer class="post-info">
        <abbr class="published" title="2017-10-19T15:00:00+02:00">
                Published: jeu. 19 octobre 2017
        </abbr>

        <address class="vcard author">
                By                         <a class="url fn" href="https://vstinner.github.io/author/victor-stinner.html">Victor Stinner</a>
        </address>
<p>In <a href="https://vstinner.github.io/category/python.html">python</a>.</p>
<p>tags: <a href="https://vstinner.github.io/tag/cpython.html">cpython</a> </p>
</footer><!-- /.post-info -->                <p>My contributions to <a class="reference external" href="https://www.python.org/">CPython</a> during 2017 Q3
(july, august, september), Part 2: &quot;Dangling threads&quot;.</p>
<p>Previous report: <a class="reference external" href="https://vstinner.github.io/contrib-cpython-2017q3-part1.html">My contributions to CPython during 2017 Q3: Part 1</a>.</p>
<p>Next reports:</p>
<ul class="simple">
<li><a class="reference external" href="https://vstinner.github.io/contrib-cpython-2017q3-part3.html">My contributions to CPython during 2017 Q3: Part 3 (funny bugs)</a>.</li>
</ul>
<p>Summary:</p>
<ul class="simple">
<li>Bugfixes: Reference cycles</li>
<li>socketserver leaking threads and processes<ul>
<li>test_logging random bug …</li></ul></li></ul>
                <a class="readmore" href="https://vstinner.github.io/contrib-cpython-2017q3-part2.html">read more</a>
                </div><!-- /.entry-content -->
            </article></li>

            <li><article class="hentry">
                <header>
                    <h1><a href="https://vstinner.github.io/contrib-cpython-2017q3-part1.html" rel="bookmark"
                           title="Permalink to My contributions to CPython during 2017 Q3: Part 1">My contributions to CPython during 2017 Q3: Part 1</a></h1>
                </header>

                <div class="entry-content">
<footer class="post-info">
        <abbr class="published" title="2017-10-18T15:00:00+02:00">
                Published: mer. 18 octobre 2017
        </abbr>

        <address class="vcard author">
                By                         <a class="url fn" href="https://vstinner.github.io/author/victor-stinner.html">Victor Stinner</a>
        </address>
<p>In <a href="https://vstinner.github.io/category/python.html">python</a>.</p>
<p>tags: <a href="https://vstinner.github.io/tag/cpython.html">cpython</a> </p>
</footer><!-- /.post-info -->                <p>My contributions to <a class="reference external" href="https://www.python.org/">CPython</a> during 2017 Q3
(july, august, september), Part 1.</p>
<p>Previous report: <a class="reference external" href="https://vstinner.github.io/contrib-cpython-2017q2-part1.html">My contributions to CPython during 2017 Q2 (part1)</a>.</p>
<p>Next reports:</p>
<ul class="simple">
<li><a class="reference external" href="https://vstinner.github.io/contrib-cpython-2017q3-part2.html">My contributions to CPython during 2017 Q3: Part 2 (dangling
threads)</a>.</li>
<li><a class="reference external" href="https://vstinner.github.io/contrib-cpython-2017q3-part3.html">My contributions to CPython during 2017 Q3: Part 3 (funny bugs)</a>.</li>
</ul>
<p>Summary:</p>
<ul class="simple">
<li>Statistics</li>
<li>Security fixes …</li></ul>
                <a class="readmore" href="https://vstinner.github.io/contrib-cpython-2017q3-part1.html">read more</a>
                </div><!-- /.entry-content -->
            </article></li>

            <li><article class="hentry">
                <header>
                    <h1><a href="https://vstinner.github.io/python-security.html" rel="bookmark"
                           title="Permalink to Python Security">Python Security</a></h1>
                </header>

                <div class="entry-content">
<footer class="post-info">
        <abbr class="published" title="2017-09-15T22:00:00+02:00">
                Published: ven. 15 septembre 2017
        </abbr>

        <address class="vcard author">
                By                         <a class="url fn" href="https://vstinner.github.io/author/victor-stinner.html">Victor Stinner</a>
        </address>
<p>In <a href="https://vstinner.github.io/category/python.html">python</a>.</p>
<p>tags: <a href="https://vstinner.github.io/tag/security.html">security</a> <a href="https://vstinner.github.io/tag/python.html">python</a> </p>
</footer><!-- /.post-info -->                <p>I am working on the Python security for years, but I never wrote anything about
that. Let's fix this!</p>
<div class="section" id="psrt">
<h2>PSRT</h2>
<p>I am part of the Python Security Response Team (PSRT): I get emails sent to
<a class="reference external" href="mailto:security&#64;python.org">security&#64;python.org</a>. I try to analyze each report to validate that the bug
is …</p></div>
                <a class="readmore" href="https://vstinner.github.io/python-security.html">read more</a>
                </div><!-- /.entry-content -->
            </article></li>

            <li><article class="hentry">
                <header>
                    <h1><a href="https://vstinner.github.io/new-python-c-api.html" rel="bookmark"
                           title="Permalink to A New C API for CPython">A New C API for CPython</a></h1>
                </header>

                <div class="entry-content">
<footer class="post-info">
        <abbr class="published" title="2017-09-07T18:00:00+02:00">
                Published: jeu. 07 septembre 2017
        </abbr>

        <address class="vcard author">
                By                         <a class="url fn" href="https://vstinner.github.io/author/victor-stinner.html">Victor Stinner</a>
        </address>
<p>In <a href="https://vstinner.github.io/category/python.html">python</a>.</p>
<p>tags: <a href="https://vstinner.github.io/tag/optimization.html">optimization</a> <a href="https://vstinner.github.io/tag/cpython.html">cpython</a> </p>
</footer><!-- /.post-info -->                <p>I am currently at a CPython sprint 2017 at Facebook. We are discussing my idea
of writing a new C API for CPython hiding implementation details and replacing
macros with function calls.</p>
<img alt="CPython sprint at Facebook, september 2017" src="https://vstinner.github.io/images/cpython_sprint_sept2017.jpg" />
<p>This article tries to explain why the CPython C API needs to <strong>evolve</strong>.</p>
<div class="section" id="c-api-prevents-further-optimizations">
<h2>C API prevents further optimizations …</h2></div>
                <a class="readmore" href="https://vstinner.github.io/new-python-c-api.html">read more</a>
                </div><!-- /.entry-content -->
            </article></li>
                </ol><!-- /#posts-list -->
<p class="paginator">
    Page 1 / 4
        <a href="https://vstinner.github.io/category/python2.html">&raquo;</a>
</p>
                </section><!-- /#content -->
        <section id="extras" class="body">
                <div class="blogroll">
                        <h2>links</h2>
                        <ul>
                            <li><a href="http://vstinner.readthedocs.org/">Victor Stinner's Notes</a></li>
                        </ul>
                </div><!-- /.blogroll -->
                <div class="social">
                        <h2>social</h2>
                        <ul>
                            <li><a href="https://vstinner.github.io/feeds/all.atom.xml" type="application/atom+xml" rel="alternate">atom feed</a></li>

                            <li><a href="https://twitter.com/VictorStinner">Follow @VictorStinner on Twitter</a></li>
                        </ul>
                </div><!-- /.social -->
        </section><!-- /#extras -->

        <footer id="contentinfo" class="body">
                <address id="about" class="vcard body">
                Proudly powered by <a href="http://getpelican.com/">Pelican</a>, which takes great advantage of <a href="http://python.org">Python</a>.
                </address><!-- /#about -->

                <p>The theme is by <a href="http://coding.smashingmagazine.com/2009/08/04/designing-a-html-5-layout-from-scratch/">Smashing Magazine</a>, thanks!</p>
        </footer><!-- /#contentinfo -->

</body>
</html>